# 架构设计文档

## 目录
- [系统概述](#系统概述)
- [架构原则](#架构原则)
- [系统架构](#系统架构)
- [模块设计](#模块设计)
- [数据流程](#数据流程)
- [设计模式](#设计模式)
- [技术栈](#技术栈)
- [部署架构](#部署架构)

## 系统概述

Auto 是一个基于 Playwright 的多站点自动化登录工具集，设计目标是提供一个可扩展、易维护的自动化登录框架，支持多站点、多账号的批量管理。

### 核心功能
- 多站点登录自动化
- Cookie 持久化和快速登录
- OAuth 授权流程支持
- 批量用户管理
- 自动化任务执行（签到、抽奖等）
- 错误处理和日志记录

## 架构原则

### 1. 关注点分离 (Separation of Concerns)
- **代码层**: 业务逻辑实现 (`src/`)
- **配置层**: 用户配置和系统设置 (`config/`)
- **数据层**: 运行时数据和持久化 (`data/`)

### 2. 继承复用 (Inheritance and Reusability)
- 所有站点登录类继承自 `LoginAutomation` 基类
- 共享通用功能：Cookie 管理、浏览器控制、错误处理

### 3. 模块化设计 (Modular Design)
- 每个站点独立模块，互不干扰
- 核心功能抽象为独立模块
- 插件式架构，易于添加新站点

### 4. 配置驱动 (Configuration-Driven)
- 所有用户数据通过配置文件管理
- 支持多种配置源（文件、环境变量）
- 运行时参数可覆盖默认配置

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                     CLI Interface                        │
│                   (src/__main__.py)                      │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                    Site Implementations                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │ LinuxDO  │ │AnyRouter │ │  OpenI   │ │  GitHub  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
│  ┌──────────────────┐ ┌──────────────────────────────┐ │
│  │   ShareYourCC    │ │    Future Sites...          │ │
│  └──────────────────┘ └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                      Core Modules                        │
│  ┌──────────────────────────────────────────────────┐  │
│  │            LoginAutomation (base.py)              │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│  │ Browser  │ │ Cookies  │ │  Config  │ │  Logger  │ │
│  │ Manager  │ │ Manager  │ │  Loader  │ │  Setup   │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ │
│  ┌─────────────────────────────────────────────────┐  │
│  │              Paths Management                    │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                    External Dependencies                 │
│  ┌──────────────────────────────────────────────────┐  │
│  │               Playwright (Browser Engine)         │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 模块设计

### 核心模块 (Core Modules)

#### 1. LoginAutomation 基类
**文件**: `src/core/base.py`

**职责**:
- 定义标准登录流程框架
- 管理浏览器生命周期
- 协调 Cookie 和登录逻辑
- 提供错误处理机制

**关键方法**:
- `run()`: 主执行流程
- `try_cookie_login()`: Cookie 快速登录
- `verify_login()`: 抽象方法，验证登录状态
- `do_login()`: 抽象方法，执行登录操作
- `after_login()`: 登录后钩子

#### 2. BrowserManager
**文件**: `src/core/browser.py`

**职责**:
- 管理 Playwright 浏览器实例
- 处理浏览器启动参数
- 提供截图功能
- 资源清理

**设计模式**: 资源管理器模式

#### 3. CookieManager
**文件**: `src/core/cookies.py`

**职责**:
- Cookie 的保存和加载
- Cookie 有效期管理
- 多账号 Cookie 隔离
- 元数据管理

**特性**:
- JSON 格式存储
- 时间戳记录
- 元数据支持（login_type, email 等）

#### 4. ConfigLoader
**文件**: `src/core/config.py`

**职责**:
- 配置文件加载
- 配置格式迁移
- 环境变量回退
- 多用户管理

**配置优先级**:
1. 命令行参数
2. 配置文件
3. 环境变量

#### 5. Logger
**文件**: `src/core/logger.py`

**职责**:
- 日志配置和初始化
- 多文件日志分离
- 日志格式统一
- 错误追踪

#### 6. Paths
**文件**: `src/core/paths.py`

**职责**:
- 统一路径管理
- 目录自动创建
- 跨平台路径处理

### 站点模块 (Site Modules)

每个站点模块包含：

```
sites/<site_name>/
├── __init__.py       # 包初始化
├── login.py          # 登录逻辑实现
├── config.py         # 站点特定配置（可选）
├── popup.py          # 弹窗处理（可选）
├── tasks.py          # 自动化任务（可选）
└── runner.py         # 批量执行器（可选）
```

#### 站点实现示例

```python
class SiteLogin(LoginAutomation):
    def __init__(self, headless: bool = False):
        super().__init__('site_name', headless=headless)

    def verify_login(self, page: Page) -> bool:
        # 站点特定的登录验证逻辑
        pass

    def do_login(self, page: Page, **credentials) -> bool:
        # 站点特定的登录操作
        pass

    def after_login(self, page: Page, **credentials) -> None:
        # 登录后的自动化任务
        pass
```

## 数据流程

### 1. 登录流程

```
用户输入
    │
    ▼
CLI 解析参数
    │
    ▼
加载配置
    │
    ▼
创建站点实例
    │
    ▼
启动浏览器
    │
    ├─── [有 Cookie] ──→ 尝试 Cookie 登录
    │                           │
    │                    [成功] ▼  [失败]
    │                           │     │
    └─── [无 Cookie] ──────────┴─────┘
                                │
                                ▼
                        执行密码登录
                                │
                         [成功] ▼  [失败]
                                │     │
                        保存 Cookie   │
                                │     │
                                ▼     ▼
                        执行后续任务  错误处理
                                │     │
                                ▼     ▼
                            清理资源  保存截图
```

### 2. Cookie 管理流程

```
Cookie 操作请求
       │
       ├─── 保存 Cookie
       │        │
       │        ▼
       │    获取浏览器上下文
       │        │
       │        ▼
       │    提取 Cookie 数据
       │        │
       │        ▼
       │    添加元数据和时间戳
       │        │
       │        ▼
       │    写入 JSON 文件
       │
       └─── 加载 Cookie
                │
                ▼
            检查文件是否存在
                │
                ▼
            验证 Cookie 有效期
                │
                ▼
            匹配元数据（如有）
                │
                ▼
            注入到浏览器上下文
```

### 3. 配置加载流程

```
程序启动
    │
    ▼
检查配置文件
    │
    ├─── [存在] ──→ 读取配置文件
    │                     │
    │                     ▼
    │                检查配置版本
    │                     │
    │              [需要迁移] [最新]
    │                  │        │
    │                  ▼        │
    │              迁移配置     │
    │                  │        │
    │                  ▼        ▼
    │              备份原配置   │
    │                  │        │
    │                  ▼        │
    │              保存新配置   │
    │                  │        │
    └─── [不存在] ────┴────────┘
                        │
                        ▼
                  尝试环境变量
                        │
                        ▼
                  返回配置数据
```

## 设计模式

### 1. 模板方法模式 (Template Method)
**应用**: `LoginAutomation` 基类

基类定义算法骨架，子类实现具体步骤：
- `run()` 方法定义登录流程模板
- 子类实现 `verify_login()` 和 `do_login()`

### 2. 策略模式 (Strategy)
**应用**: 多种登录方式

不同站点有不同的登录策略：
- 密码登录
- OAuth 登录
- Cookie 登录

### 3. 单例模式 (Singleton)
**应用**: `ProjectPaths`

确保路径配置全局唯一：
```python
_project_paths = None

def get_project_paths() -> ProjectPaths:
    global _project_paths
    if _project_paths is None:
        _project_paths = ProjectPaths()
    return _project_paths
```

### 4. 工厂模式 (Factory)
**应用**: CLI 命令处理

根据命令创建对应的站点实例：
```python
def create_site_login(site: str, **kwargs):
    if site == 'linuxdo':
        return LinuxdoLogin(**kwargs)
    elif site == 'anyrouter':
        return AnyrouterLogin(**kwargs)
    # ...
```

### 5. 装饰器模式 (Decorator)
**应用**: 日志和错误处理

通过装饰器添加额外功能：
- 日志记录
- 性能监控
- 错误重试

## 技术栈

### 核心技术
- **Python 3.8+**: 主要开发语言
- **Playwright**: 浏览器自动化引擎
- **asyncio**: 异步并发支持（部分模块）

### 依赖库
- **playwright==1.48.0**: 浏览器自动化
- **标准库**:
  - `json`: 配置和数据存储
  - `pathlib`: 路径操作
  - `logging`: 日志记录
  - `datetime`: 时间处理
  - `os`: 环境变量

### 开发工具
- **Git**: 版本控制
- **pytest**: 单元测试（推荐）
- **black**: 代码格式化（推荐）
- **pylint**: 代码质量检查（推荐）

## 部署架构

### 单机部署

```
┌─────────────────────────────────────┐
│           Host Machine               │
│                                      │
│  ┌────────────────────────────────┐ │
│  │     Python Runtime              │ │
│  │  ┌──────────────────────────┐  │ │
│  │  │      Auto Application     │  │ │
│  │  └──────────────────────────┘  │ │
│  │  ┌──────────────────────────┐  │ │
│  │  │   Playwright + Chromium   │  │ │
│  │  └──────────────────────────┘  │ │
│  └────────────────────────────────┘ │
│                                      │
│  ┌────────────────────────────────┐ │
│  │        File System              │ │
│  │  ┌──────┐ ┌──────┐ ┌────────┐ │ │
│  │  │Config│ │ Data │ │  Logs  │ │ │
│  │  └──────┘ └──────┘ └────────┘ │ │
│  └────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 容器化部署

```
┌─────────────────────────────────────┐
│         Docker Container             │
│                                      │
│  ┌────────────────────────────────┐ │
│  │     Python 3.x Alpine           │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │      Auto Application           │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │   Playwright + Chromium         │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │    Xvfb (Virtual Display)       │ │
│  └────────────────────────────────┘ │
└─────────────────────────────────────┘
           │                │
      Volume Mounts    Port Mappings
           │                │
    ┌──────┴──────┐         │
    │ Host System │         │
    │   Volumes   │    (if needed)
    └─────────────┘
```

### 分布式部署

```
┌──────────────────────────────────────────┐
│            Load Balancer                  │
└──────────────────────────────────────────┘
                    │
    ┌───────────────┼───────────────┐
    ▼               ▼               ▼
┌─────────┐    ┌─────────┐    ┌─────────┐
│Worker 1 │    │Worker 2 │    │Worker N │
│  Auto   │    │  Auto   │    │  Auto   │
└─────────┘    └─────────┘    └─────────┘
     │              │              │
     └──────────────┼──────────────┘
                    ▼
         ┌──────────────────┐
         │  Shared Storage  │
         │ (Cookies, Logs)  │
         └──────────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │   Message Queue  │
         │  (Task Dispatch) │
         └──────────────────┘
```

## 安全架构

### 1. 凭据安全
- 密码不在代码中硬编码
- 配置文件应设置适当权限 (600)
- 支持环境变量传递敏感信息
- 日志中不记录密码

### 2. Cookie 安全
- Cookie 文件权限控制
- Cookie 有效期验证
- 元数据验证防止混用
- 定期清理过期 Cookie

### 3. 网络安全
- 强制使用 HTTPS
- 支持代理配置
- 请求超时控制
- 重试机制避免 DOS

### 4. 运行时安全
- 沙箱化浏览器环境
- 资源使用限制
- 错误隔离
- 敏感操作审计

## 性能优化

### 1. Cookie 缓存
- 减少重复登录操作
- 提高批量处理效率
- 降低目标站点负载

### 2. 并发控制
- 多用户并行处理
- 站点级别限流
- 智能等待策略

### 3. 资源管理
- 浏览器实例复用
- 及时释放内存
- 日志轮转机制

### 4. 网络优化
- 请求合并
- 静态资源缓存
- 图片加载控制

## 可扩展性

### 添加新站点
1. 创建站点模块目录
2. 继承 `LoginAutomation` 基类
3. 实现必要的抽象方法
4. 在 CLI 中注册命令
5. 更新配置模板

### 添加新功能
1. 核心功能 → 扩展基类
2. 站点特定 → 扩展站点类
3. 通用工具 → 添加到 core 模块
4. 批处理 → 创建 runner 模块

### 自定义扩展点
- 登录前/后钩子
- 自定义验证逻辑
- 任务调度接口
- 通知集成

## 监控和调试

### 日志系统
- 分级日志（DEBUG/INFO/WARNING/ERROR）
- 按站点分离日志文件
- 时间戳和上下文信息
- 错误堆栈跟踪

### 调试支持
- 非无头模式可视化调试
- 步进式执行
- 截图保存
- 网络请求记录

### 性能监控
- 登录耗时统计
- Cookie 命中率
- 错误率统计
- 资源使用监控

## 未来规划

### 短期目标
1. 添加更多站点支持
2. 完善错误恢复机制
3. 优化 Cookie 管理策略
4. 添加 Web UI 界面

### 中期目标
1. 分布式任务调度
2. API 服务化
3. 插件系统
4. 智能验证码处理

### 长期愿景
1. AI 辅助登录
2. 自适应反爬虫
3. 跨平台 GUI 应用
4. 企业级解决方案